{extend name="base"/}
{block name="resources"}
<link rel="stylesheet" href="SHOP_CSS/index.css?v=20220111">
{/block}
{block name="main"}

<div class="ns-survey">
	<div class="ns-survey-left">
		<div class="ns-survey-item">
			<!-- 商家信息 -->
			<!-- <div class="ns-survey-shop">
				<div class="ns-item-pic">
					<img layer-src src="{:img($shop_info['logo'])}" onerror=src="SHOP_IMG/default_shop.png" />
				</div>

				<div class="ns-surver-shop-detail">
					<p class="ns-survey-shop-name">{$shop_info.site_name}
					</p>
					<p class="ns-text-color-dark-gray"></p>
					<p class="ns-text-color-dark-gray">用户名：<span>{$user_info.username}</span></p>
					<p class="ns-text-color-dark-gray">登录ip：<span>{$user_info.login_ip}</span></p>
					<p>最后登录：<span class="ns-text-color-dark-gray">{php} echo date("Y-m-d H:i:s", $user_info['login_time']);{/php}</span></p>
				</div>
				
			</div> -->

			<!-- 概况 -->
			<div class="layui-card ns-survey-info ns-card-common">
				<div class="layui-card-header">
					<div>
						<span class="ns-card-title">实时概况</span>
						<span class="ns-card-sub" id = "today">更新时间：{$today}</span>
					</div>
				</div>
				<div class="layui-card-body">
					<div class="ns-survey-detail-con">
						<div class="ns-survey-detail-aco">今日订单数
							<div class="ns-prompt-block" style="left: 100px;top: 20px;">
							<div class="ns-prompt">
								<i class="iconfont iconwenhao1 required ns-growth"></i>
								<div class="ns-growth-box ns-reason-box ns-reason-growth ns-prompt-box" style="top: 30px;left: -64px;">
									<div class="ns-prompt-con">
										<p>只要支付过的订单都会参与统计,包括支付后关闭和退款订单。</p>
									</div>
								</div>
							</div>
							</div>
						</div>
						<p class="ns-survey-detail-num ns-text-color" id="order_pay_count">0</p>
						<div class="ns-survey-detail-rate">
							<div>日同比 <span id="day_rate_order_pay_count">100</span><i class="layui-icon layui-icon-triangle-d "></i></div>
							<div>昨日订单数 <span id="stat_yesterday_order_pay_count">0 </span></div>
						</div>
						<div class="ns-survey-detail-split"></div>
						<div class="ns-survey-detail-total">
							<span>订单总数</span>
							<span id="shop_stat_sum_order_pay_count">0</span>
						</div>
						<div class="title ns-prompt-block">
							<div class="ns-prompt">
								<button class="layui-btn layui-btn-primary ns-text-color ns-border-color ns-survey-yesterday-btn">昨日</button>
								<div class="ns-prompt-box">
									<div class="ns-prompt-con">
										订单数：<span id="stat_yesterday_order_pay_counts">0</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="ns-survey-detail-con">
						<!-- <p class="ns-survey-detail-aco">今日销售额(元)</p> -->
						<div class="ns-survey-detail-aco">今日销售额(元)
							<div class="ns-prompt-block" style="left: 126px;top: 20px;">
							<div class="ns-prompt">
								<i class="iconfont iconwenhao1 required ns-growth"></i>
								<div class="ns-growth-box ns-reason-box ns-reason-growth ns-prompt-box" style="top: 30px;left: -64px;">
									<div class="ns-prompt-con">
										<p>只要支付成功的订单销售额都会参与统计,不去除退款部分。</p>
									</div>
								</div>
							</div>
							</div>
						</div>
						<p class="ns-survey-detail-num ns-text-color" id="stat_day_order_total"> 0.00 </p>
						<div class="ns-survey-detail-rate">
							<div>日同比 <span id="day_rate_order_total">100</span><i class="layui-icon layui-icon-triangle-d"></i></div>
							<div>昨日销售额(元) <span id="stat_yesterday_order_total">0.00</span>
							</div>
						</div>
						<div class="ns-survey-detail-split"></div>
						<div class="ns-survey-detail-total">
							<span>销售总额</span>
							<span id="shop_stat_sum_order_total">0.00</span>
						</div>
						<!-- <p class="ns-survey-detail-yesterday">昨日：{if isset($stat_yesterday.order_total)}{$stat_yesterday.order_total}{else /} 0.00 {/if}</p> -->
						<div class="title ns-prompt-block">
							<div class="ns-prompt">
								<button class="layui-btn layui-btn-primary ns-text-color ns-border-color ns-survey-yesterday-btn">昨日</button>
								<div class="ns-prompt-box">
									<div class="ns-prompt-con">
										销售额：<span id="stat_yesterday_order_totals">0.00</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="ns-survey-detail-con">
						<div class="ns-survey-detail-aco">今日新增会员数
							<div class="ns-prompt-block" style="left: 131px;top: 20px;">
							<div class="ns-prompt">
								<i class="iconfont iconwenhao1 required ns-growth"></i>
								<div class="ns-growth-box ns-reason-box ns-reason-growth ns-prompt-box" style="top: 30px;left: -64px;">
									<div class="ns-prompt-con">
										<p>新注册的会员账号会参与统计,不去除注销会员。</p>
									</div>
								</div>
							</div>
							</div>
						</div>
						<p class="ns-survey-detail-num ns-text-color" id="stat_day_member_count">0</p>
						<div class="ns-survey-detail-rate">
							<div>日同比 <span id="day_rate_member_count">100</span><i class="layui-icon layui-icon-triangle-d"></i></div>
							<div>昨日新增会员数 <span id="stat_yesterday_member_count">0 </span></div>
						</div>
						<div class="ns-survey-detail-split"></div>
						<div class="ns-survey-detail-total">
							<span>会员总数</span>
							<span id="shop_stat_sum_member_count">0</span>
						</div>
						<div class="title ns-prompt-block">
							<div class="ns-prompt">
								<button class="layui-btn layui-btn-primary ns-text-color ns-border-color ns-survey-yesterday-btn">昨日</button>
								<div class="ns-prompt-box">
									<div class="ns-prompt-con">
										会员数：<span id="stat_yesterday_member_counts">0</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="ns-survey-detail-con">
						<div class="ns-survey-detail-aco">今日浏览量
							<div class="ns-prompt-block" style="left: 100px;top: 20px;">
							<div class="ns-prompt">
								<i class="iconfont iconwenhao1 required ns-growth"></i>
								<div class="ns-growth-box ns-reason-box ns-reason-growth ns-prompt-box" style="top: 30px;left: -64px;">
									<div class="ns-prompt-con">
										<p>所有会员登录状态下进入商品详情页的次数之和。</p>
									</div>
								</div>
							</div>
							</div>
						</div>
						<p class="ns-survey-detail-num ns-text-color" id="stat_day_visit_count">0</p>
						<div class="ns-survey-detail-rate">
							<div>日同比 <span id="day_rate_visit_count">100</span><i class="layui-icon layui-icon-triangle-d "></i></div>
							<div>昨日浏览量 <span id="stat_yesterday_visit_count">0</span>
<!--								<i class="layui-icon layui-icon-triangle-d"></i>-->
							</div>
						</div>
						<div class="ns-survey-detail-split"></div>
						<div class="ns-survey-detail-total">
							<span>总浏览量</span>
							<span id="shop_stat_sum_visit_count">0</span>
						</div>
						<div class="title ns-prompt-block">
							<div class="ns-prompt">
								<button class="layui-btn layui-btn-primary ns-text-color ns-border-color ns-survey-yesterday-btn">昨日</button>
								<div class="ns-prompt-box">
									<div class="ns-prompt-con">
										浏览量：<span id="stat_yesterday_visit_counts">0</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

		</div>

		<div class="statistics-wrap">
			<div class="item">
				<div class="flex-box" style="background: rgba(255, 125, 68, 0.1);" onclick="location.href='{:addon_url('shop/order/lists')}#!order_status=0'">
					<h5 class="title">待付款订单</h5>
					<div class="num" id="waitpay">0</div>
				</div>
				<div class="flex-box" style="background: rgba(255, 69, 68, 0.1);" onclick="location.href='{:addon_url('shop/delivery/lists')}'">
					<h5 class="title">待发货订单</h5>
					<div class="num" id="waitsend">0</div>
				</div>
			</div>

			{if $is_fenxiao eq 0}
			<div class="item">
				<div class="flex-box" style="background: rgba(255, 125, 68, 0.1);" onclick="location.href='{:addon_url('shop/order/lists')}#!order_status=3'">
					<h5 class="title">待收货订单</h5>
					<div class="num" id="waitconfirm">0</div>
				</div>
				<div class="flex-box" style="background: rgba(255, 69, 68, 0.1);" onclick="location.href='{:addon_url('shop/order/lists')}#!order_status=10'">
					<h5 class="title">已完成订单</h5>
					<div class="num" id="complete">0</div>
				</div>
			</div>
			{/if}

			<div class="item">
				<div class="flex-box" style="background: rgba(80, 130, 255, 0.1);" onclick="location.href='{:addon_url('shop/orderrefund/lists')}'">
					<h5 class="title">退款中订单</h5>
					<div class="num" id="refund">0</div>
				</div>
				<div class="flex-box" style="background: rgba(255, 125, 68, 0.1);" onclick="location.href='{:addon_url('shop/goods/lists?stockalarm=1')}'">
					<h5 class="title">库存预警</h5>
					<div class="num" id="goods_stock_alarm">0</div>
				</div>
			</div>

			<div class="item">
				<div class="flex-box" style="background: rgba(60, 188, 66, 0.1);" onclick="location.href='{:addon_url('shop/goods/lists', ['state' => 1])}'">
					<h5 class="title">出售中商品</h5>
					<div class="num" id="goods_total">0</div>
				</div>
				<div class="flex-box" style="background: rgba(255, 174, 68, 0.1);" onclick="location.href='{:addon_url('shop/goods/lists', ['state' => 0])}'">
					<h5 class="title">仓库中商品</h5>
					<div class="num" id="warehouse_goods">0</div>
				</div>
			</div>
			
			{if $is_fenxiao eq 1}
			<div class="item">
				<div class="flex-box" style="background: rgba(38, 189, 216, 0.1)" onclick="location.href='{:addon_url('fenxiao://shop/fenxiao/apply')}'">
					<h5 class="title">分销商申请</h5>
					<div class="num" id="apply_count"></div>
				</div>
				<div class="flex-box" style="background: rgba(121, 68, 255, 0.1)" onclick="location.href='{:addon_url('fenxiao://shop/withdraw/lists')}'">
					<h5 class="title">提现待审核</h5>
					<div class="num" id="withdraw_count">0</div>
				</div>
			</div>
			{/if}
		</div>
		
		<div class="echarts-wrap">
			<div class="echarts-order">
				<h5>近十天订单数(个)</h5>
				<div id="order" style="width: 100%; height: 400px;"></div>
			</div>
			
			<div class="echarts-money">
				<h5>销售额(元)</h5>
				<div id="money" style="width: 100%; height: 400px;"></div>
			</div>
		</div>

		<!-- 常用功能 -->
		<div class="layui-card ns-card-common">
			<div class="layui-card-header">
				<div>
					<span class="ns-card-title">常用功能</span>
				</div>
			</div>

			<div class="layui-card-body">
				<div class="common-functions">
					<a class="common-functions-item" href="{:url('shop/goods/addgoods')}">
						<div class="common-functions-box">
							<div class="ns-item-pic">
								<img src="SHOP_IMG/menu_icon/issue_good.png">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">发布商品</div>
								<p class="ns-item-content-desc">发布实物商品</p>
							</div>
						</div>
					</a>
					<a class="common-functions-item" href="{:url('shop/diy/index')}">
						<div class="common-functions-box">
							<div class="ns-item-pic">
								<img src="SHOP_IMG/menu_icon/page_decoration.png">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">店铺装修</div>
								<p class="ns-item-content-desc">主页面进行装修</p>
							</div>
						</div>
					</a>
					<a class="common-functions-item" href="{:url('shop/shop/config')}">
						<div class="common-functions-box">
							<div class="ns-item-pic">
								<img src="SHOP_IMG/menu_icon/shop_settings.png">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">店铺设置</div>
								<p class="ns-item-content-desc">修改店铺信息</p>
							</div>
						</div>
					</a>
					<a class="common-functions-item" href="{:url('shop/order/lists')}">
						<div class="common-functions-box">
							<div class="ns-item-pic">
								<img src="SHOP_IMG/menu_icon/order_select.png">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">订单查询</div>
								<p class="ns-item-content-desc">查询系统普通订单</p>
							</div>
						</div>
					</a>

					<a class="common-functions-item" href="{:url('shop/member/index')}">
						<div class="common-functions-box">
							<div class="ns-item-pic">
								<img src="SHOP_IMG/menu_icon/member_manage.png">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">会员管理</div>
								<p class="ns-item-content-desc">店铺会员管理</p>
							</div>
						</div>
					</a>
					<a class="common-functions-item" href="{:url('shop/memberwithdraw/lists')}">
						<div class="common-functions-box">
							<div class="ns-item-pic">
								<img src="SHOP_IMG/menu_icon/member_withdraw.png">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">会员提现</div>
								<p class="ns-item-content-desc">店铺会员提现</p>
							</div>
						</div>
					</a>

					{if $is_fenxiao == 1}
					<a class="common-functions-item" href="{:addon_url('fenxiao://shop/order/lists')}">
						<div class="common-functions-box">
							<div class="ns-item-pic">
								<img src="SHOP_IMG/menu_icon/fenxiao_order.png">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">分销订单</div>
								<p class="ns-item-content-desc">店铺分销订单</p>
							</div>
						</div>
					</a>
					<a class="common-functions-item" href="{:addon_url('fenxiao://shop/fenxiao/index')}">
						<div class="common-functions-box">
							<div class="ns-item-pic">
								<img src="SHOP_IMG/menu_icon/fenxiao_config.png">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">分销管理</div>
								<p class="ns-item-content-desc">店铺分销管理</p>
							</div>
						</div>
					</a>

					{/if}
				</div>
			</div>
		</div>
		
		
		<div class="addon-tool">
			
			<!-- 插件 -->
			<div class="layui-card ns-card-common">
				{if $count['shopcount']!=0}
				<div class="layui-card-header">
					<div>
						<span class="ns-card-title">营销活动</span>
						<a class="ns-text-color" href="{:addon_url('shop/promotion/index')}">更多</a>
					</div>
				</div>
				{/if}
				<div class="layui-card-body">
					<div class="ns-item-block-parent">
						{php} $num = 0; {/php}
						{foreach $promotion as $list_k => $list_v}
						{empty name="$list_v['is_developing']"}
						{if in_array($list_v['show_type'],['shop','member']) && $num <5}
						{php} $num++;{/php}
						<a class="addon-tool-item" {empty name="$list_v['is_developing']"} href="{:addon_url($list_v['url'])}" {/empty}>
						<div class="ns-item-block-wrap">
							<div class="ns-item-pic">
								<img src="{:img($list_v.icon)}">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">{$list_v.title}</div>
								<p class="ns-item-content-desc ns-line-hiding" title="{$list_v.description}">{$list_v.description}</p>
							</div>
						</div>
						</a>
						{/if}
						{/empty}
						{/foreach}
					</div>
				</div>
			</div>

			<div class="layui-card ns-card-common">
				{if $count['toolcount']!=0}
				<div class="layui-card-header">
					<div>
						<span class="ns-card-title">应用工具</span>
						<a class="ns-text-color" href="{:addon_url('shop/promotion/tool')}">更多</a>
					</div>
				</div>
				{/if}
				<div class="layui-card-body">
					<div class="ns-item-block-parent">
						{php} $tool_num = 0; {/php}
						{foreach $promotion as $list_k => $list_v}
						{empty name="$list_v['is_developing']"}

						{if $list_v['show_type'] == 'tool' && $tool_num < 5}
						{php} $tool_num++; {/php}
						<a class="addon-tool-item" {empty name="$list_v['is_developing']"} href="{:addon_url($list_v['url'])}" {/empty}>
						<div class="ns-item-block-wrap">
							<div class="ns-item-pic">
								<img src="{:img($list_v.icon)}">
							</div>
							<div class="ns-item-con">
								<div class="ns-item-content-title">{$list_v.title}</div>
								<p class="ns-item-content-desc ns-line-hiding" title="{$list_v.description}">{$list_v.description}</p>
							</div>
						</div>
						</a>
						{/if}

						{/empty}
						{/foreach}
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{/block}
{block name="script"}
<script src="SHOP_JS/echarts.min.js"></script>
<script>
    $(function () {
        $("body").on("click", ".ns-shop-state button", function () {
            location.href = ns.url("shop/index/renewExpireTime");
        });
    });
</script>
<script>
	// 今日昨日统计
	getDayCount();
	// 综合统计
	getSumCount()
	// 图形统计
	getChartCount()
	
	function getDay(day){
	    var today = new Date();
	    var targetday_milliseconds = today.getTime() + 1000 * 60 * 60 * 24 * day;
	    today.setTime(targetday_milliseconds); //注意，这行是关键代码
	    var tYear = today.getFullYear();
	    var tMonth = today.getMonth();
	    var tDate = today.getDate();
	    tMonth = doHandleMonth(tMonth + 1);
	    tDate = doHandleMonth(tDate);
	    return tMonth + "-" + tDate;
	}
	
	function doHandleMonth(month){
	    var m = month;
	    if(month.toString().length == 1){
	     m = "0" + month;
	    }
	    return m;
	}

	//今日昨日统计
	function getDayCount(){
		$.ajax({
			type: 'post',
			dataType: 'json',
			url: ns.url("shop/index/dayCount"),
			success: function (res) {
				$('#order_pay_count').html(res.stat_day.order_pay_count);
				$('#day_rate_order_pay_count').html(res.day_rate.order_pay_count);
				$('#stat_yesterday_order_pay_count').html(res.stat_yesterday.order_pay_count);
				$('#shop_stat_sum_order_pay_count').html(res.shop_stat_sum.order_pay_count);
				$('#stat_day_order_total').html(res.stat_day.order_total);
				$('#stat_yesterday_order_total').html(res.stat_yesterday.order_total);
				$('#shop_stat_sum_order_total').html(res.shop_stat_sum.order_total);
				$('#stat_yesterday_order_totals').html(res.stat_yesterday.order_total);
				$('#stat_yesterday_order_pay_counts').html(res.stat_yesterday.order_pay_count);
				$('#stat_day_member_count').html(res.stat_day.member_count);
				$('#stat_yesterday_member_count').html(res.stat_yesterday.member_count);
				$('#shop_stat_sum_member_count').html(res.shop_stat_sum.member_count);
				$('#stat_yesterday_member_counts').html(res.stat_yesterday.member_count);
				$('#stat_day_visit_count').html(res.stat_day.visit_count);
				$('#stat_yesterday_visit_count').html(res.stat_yesterday.visit_count);
				$('#shop_stat_sum_visit_count').html(res.shop_stat_sum.visit_count);
				$('#stat_yesterday_visit_counts').html(res.stat_yesterday.visit_count);
				$('#day_rate_order_total').html(res.day_rate.order_total);
				$('#day_rate_visit_count').html(res.day_rate.visit_count);
				$('#day_rate_member_count').html(res.day_rate.member_count);
			}
		})
	}

	//综合统计
	function getSumCount() {
		$.ajax({
			type:'post',
			dataType:'json',
			url:ns.url('shop/index/sumCount'),
			success:function(res){
				$('#waitpay').html(res.waitpay);
				$('#apply_count').html(res.apply_count);
				$('#goods_stock_alarm').html(res.goods_stock_alarm);
				$('#goods_total').html(res.goods_total);
				$('#refund').html(res.refund);
				$('#waitsend').html(res.waitsend);
				$('#warehouse_goods').html(res.warehouse_goods);
				$('#withdraw_count').html(res.withdraw_count);
			}
		})
	}

	//图形统计
	function getChartCount() {
		$.ajax({
			type:'post',
			dataType:'json',
			url:ns.url('shop/index/chartCount'),
			success:function(res){
				dealWithChart(res);
			}
		})
	}

	function dealWithChart(ten_day_json){
		var data = [getDay(-9), getDay(-8), getDay(-7), getDay(-6), getDay(-5), getDay(-4), getDay(-3), getDay(-2), getDay(-1), getDay(0)];
		// 基于准备好的dom，初始化echarts实例
		var myChart = echarts.init(document.getElementById('order'));
		
		// 指定图表的配置项和数据
		option = {
			xAxis: {
				type: 'category',
				data: data
			},
			yAxis: {
				type: 'value'
			},
			tooltip: {
				formatter: function(params, ticket, callback) {
					return "日期：" + data[params.dataIndex] + '<br />' + params.seriesName + "：" + params.value;
				},
				backgroundColor: 'rgba(0, 0, 0, 0.5)',
				padding: [5, 10],
				textStyle: {
					color: '#fff',
					lineHeight: 30,
				}
			},
			series: [{
				name: ['订单数'],
				data: ten_day_json.order_pay_count,
				type: 'bar',
				showBackground: true,
				barCategoryGap: '50%',
				itemStyle: {
					color: new echarts.graphic.LinearGradient(
						0, 0, 0, 1,
						[
							{offset: 0, color: '#e38c62'},
							{offset: 1, color: '#ff8143'}
						]
					)
				}
			}]
		};

		// 使用刚指定的配置项和数据显示图表。
		myChart.setOption(option);
		
		// 基于准备好的dom，初始化echarts实例
		var moneyChart = echarts.init(document.getElementById('money'));
		
		// 指定图表的配置项和数据
		moneyOption = {
			xAxis: {
				type: 'category',
				data: data
			},
			yAxis: {
				type: 'value'
			},
			tooltip: {
				trigger: 'axis',
				showContent: true,
				backgroundColor: 'rgba(0, 0, 0, 0.5)',
				padding: [5, 10],
				textStyle: {
					color: '#fff',
					lineHeight: 30,
				},
				formatter: function(params, ticket, callback) {
					return "日期：" + params[0].axisValue + '<br />' + params[0].seriesName + "：" + params[0].value + "元";
				},
			},
			series: [{
				name: ['销售额'],
				data: ten_day_json.order_total,
				type: 'line',
				smooth: true,
				itemStyle: {
					color: '#FF8143'
				}
			}]
		};

		// 使用刚指定的配置项和数据显示图表。
		moneyChart.setOption(moneyOption);
	}
		
</script>
{/block}
{/block}